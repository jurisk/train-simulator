= Useful Commands

== CI/CD Status

image::https://github.com/jurisk/train-simulator/actions/workflows/rust.yml/badge.svg[Rust,link=https://github.com/jurisk/train-simulator/actions/workflows/rust.yml]

https://jurisk.github.io/train-simulator-pages/[Online version]

== Useful commands

=== Housekeeping

Rare:

[source,bash]
----
rustup update
cargo update
cargo udeps --all-targets
cargo audit
----

Frequent:

[source,bash]
----
cargo fmt
cargo clippy -- -W clippy::pedantic -W clippy::style -W clippy::unwrap_used -W clippy::expect_used
----

=== Running

Reminder. Do not forget to use `--features bevy/dynamic_linking` when running from the IDE.

[source,bash]
----
cargo run --features bevy/dynamic_linking --bin server_renet_console
cargo run --features bevy/dynamic_linking --bin client_renet
cargo run --features bevy/dynamic_linking --bin client_single_player
----

=== Prerequisites

On macOS:

[source,bash]
----
brew install llvm
----

From https://bevyengine.org/learn/quick-start/getting-started/setup/#enable-fast-compiles-optional[Enable Fast Compiles]:

[source,bash]
----
cargo install -f cargo-binutils
rustup component add llvm-tools-preview
----

From https://github.com/bevyengine/bevy/tree/main/examples#wasm[WASM examples]:

[source,bash]
----
rustup target add wasm32-unknown-unknown
cargo install wasm-bindgen-cli
----

=== WASM build

[source,bash]
----
cargo build --profile wasm-release --target wasm32-unknown-unknown --bin client_single_player
wasm-bindgen --out-name client_single_player --out-dir client/single-player/web/wasm-build --target web target/wasm32-unknown-unknown/wasm-release/client_single_player.wasm
----

=== Dependency tree

Not sure why, but the resulting `.dot` files would open in the JetBrains IDE plug-in, but not with the `dot` command-line tool.

[source,bash]
----
cargo install cargo-depgraph
cargo depgraph --all-deps
cargo depgraph --all-deps --dedup-transitive-deps
cargo depgraph --workspace-only
dot -Tsvg input.dot -o output.svg
----

Later: Could add a CI action to check that the `--workspace-only` graph hasn't changed and isn't circular.

=== Visualise structure

Example, for the `game-logic` package:

[source,bash]
----
cargo install cargo-modules
cargo modules dependencies --no-externs --no-fns --no-sysroot --no-traits --no-types --no-uses --package game-logic > game-logic-module.dot
----

=== Run as Docker

Building and running the Docker image:

[source,bash]
----
docker build --tag train-simulator .
docker image ls train-simulator
docker run --interactive --tty --rm --name train-simulator --publish 5000:5000/udp --publish 8080:8080/tcp train-simulator
docker stop train-simulator
----

Pruning, as Rancher tends to eat up all available space:

[source,bash]
----
docker system prune -f
docker builder prune -f
----